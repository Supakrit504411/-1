<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PEA Engineering Tools</title>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* CSS ‡πÄ‡∏î‡∏¥‡∏° */
        body { font-family: 'Sarabun', sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        nav { background-color: #1a237e; width: 100%; padding: 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); display: flex; justify-content: center; flex-wrap: wrap; }
        nav button { background-color: transparent; color: #c5cae9; border: none; padding: 15px 20px; font-size: 16px; font-weight: 600; cursor: pointer; border-bottom: 4px solid transparent; transition: all 0.3s; flex-grow: 1; max-width: 200px; }
        nav button:hover { color: white; background-color: rgba(255,255,255,0.1); }
        nav button.active { color: white; border-bottom: 4px solid #ffca28; }
        .container { background-color: white; padding: 30px; border-radius: 12px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08); width: 90%; max-width: 500px; margin-top: 30px; margin-bottom: 30px; }
        h2 { text-align: center; color: #333; margin-top: 0; padding-bottom: 15px; border-bottom: 1px solid #eee; }
        .input-group { margin-bottom: 15px; } .input-row { display: flex; gap: 15px; margin-bottom: 15px; } .input-half { flex: 1; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #444; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; background-color: #fff; }
        .quick-btn-group { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px; }
        .quick-btn { flex: 1; min-width: 50px; padding: 8px; background-color: #e3f2fd; border: 1px solid #90caf9; color: #1565c0; border-radius: 20px; cursor: pointer; font-size: 14px; transition: 0.2s; text-align: center; }
        button.calculate-btn { width: 100%; padding: 12px; background-color: #1a237e; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 15px; transition: background 0.3s; }
        button.calculate-btn:hover { background-color: #0d47a1; }
        button:disabled { background-color: #ccc !important; cursor: not-allowed; }
        .external-link-btn { display: block; width: 100%; text-align: center; padding: 10px; background-color: #ff9800; color: white; text-decoration: none; border-radius: 6px; margin-top: 15px; font-weight: bold; transition: background 0.3s; box-sizing: border-box;}
        .result { margin-top: 25px; padding: 20px; background-color: #f8f9fa; border-left: 5px solid #1a237e; border-radius: 4px; display: none; }
        .result p { margin: 8px 0; color: #333; font-size: 16px; }
        .result strong { color: #d32f2f; font-size: 19px; }
        .note { font-size: 13px; color: #555; margin-top: 15px; padding-top: 10px; border-top: 1px dashed #ccc; line-height: 1.6; }
        .small-text { font-size: 13px; color: #555; font-weight: normal; }
        .credit-box { margin-top: 12px; padding: 10px; border-top: 1px dashed #ccc; color: #1a237e; font-weight: 600; text-align: center; background-color: #e8eaf6; border-radius: 5px; }
        
        .gps-status { text-align: center; padding: 15px; background: #e3f2fd; border-radius: 8px; margin-bottom: 15px; border: 1px solid #90caf9; transition: background 0.3s;}
        .gps-status.waiting { background: #fff3e0; border-color: #ffb74d; }
        .gps-val { font-size: 24px; font-weight: bold; color: #1565c0; display: block; margin: 5px 0;}
        .gps-label { font-size: 14px; color: #555; }
        
        .manual-pin-btn { background-color: #f57f17 !important; margin-top: 10px; font-size: 18px !important; padding: 20px !important; box-shadow: 0 4px 6px rgba(0,0,0,0.2); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        .history-list { margin-top: 20px; border-top: 2px solid #eee; padding-top: 15px; }
        .history-item { background: #fff; border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 6px; display: flex; flex-direction:column; gap:10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); position: relative;}
        .history-info { font-size: 15px; color: #333; font-weight:bold;}
        .history-meta { font-size: 12px; color: #777; }
        .history-actions { display:flex; gap:5px; width:100%;}
        .history-actions button { flex:1; padding: 8px; font-size: 13px; border-radius: 4px; cursor: pointer; border: none; color: white; display:flex; justify-content:center; align-items:center;}
        .upload-status { font-size: 12px; color: #2e7d32; font-weight: bold; position: absolute; top: 10px; right: 10px; display: none;}
        
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 20px; border-radius: 8px; width: 80%; max-width: 350px; text-align: center; position: relative;}
        .modal input { margin: 15px 0; text-align: center; letter-spacing: 5px; font-weight: bold; }
        
        /* Image Preview Style */
        .photo-preview { width: 100%; max-height: 200px; object-fit: contain; margin-top: 10px; border: 1px solid #ddd; border-radius: 4px; display: none; }
        .photo-btn { background-color: #607d8b; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 5px;}
        
        footer { margin-top: auto; margin-bottom: 20px; color: #777; font-size: 14px; text-align: center; font-weight: 600; }
        .tab-content { display: none; animation: fadeIn 0.4s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <nav>
        <button onclick="openTab('ampToUnit')" id="btn-ampToUnit" style="display:none;">1. ‡πÅ‡∏õ‡∏•‡∏á Amp</button>
        <button onclick="openTab('solarRoof')" id="btn-solarRoof" style="display:none;">2. Solar Roof</button>
        <button onclick="openTab('voltageDrop')" id="btn-voltageDrop" style="display:none;">3. V-Drop</button>
        
        <button onclick="openTab('gpsSurvey')" id="btn-gpsSurvey" class="active" style="max-width: none;">‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á (GIS Survey)</button>
    </nav>

    <div class="container">
        <div id="ampToUnit" class="tab-content">
             <h2>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÑ‡∏ü‡∏ü‡πâ‡∏≤</h2>
             </div>
        <div id="solarRoof" class="tab-content">
             <h2>‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô Solar Rooftop</h2>
             </div>
        <div id="voltageDrop" class="tab-content">
             <h2>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Voltage Drop</h2>
             </div>

        <div id="gpsSurvey" class="tab-content active">
            <h2>‡∏™‡∏≥‡∏£‡∏ß‡∏à‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á (‡πÅ‡∏ö‡∏ö‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î)</h2>
            
            <div style="background: #f1f8e9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #c5e1a5;">
                <label style="margin-bottom:10px;">üì∏ ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (Optional):</label>
                <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;" onchange="handleImageSelect(this)">
                <button class="photo-btn" onclick="document.getElementById('cameraInput').click()">
                    üì∑ ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ / ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ
                </button>
                <img id="previewImg" class="photo-preview">
                <div id="imgStatus" style="font-size:12px; color:#555; display:none;">‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏†‡∏≤‡∏û</div>
            </div>

            <div id="gpsBox" class="gps-status">
                <span id="gpsStatusText">‡∏Å‡∏î "‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏£‡∏ß‡∏à" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î GPS</span>
                <hr style="border:0; border-top:1px solid #90caf9; margin:10px 0;">
                <div style="display:flex; justify-content:space-between;">
                    <div style="flex:1;">
                        <span class="gps-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏°‡∏∏‡∏î</span>
                        <span class="gps-val" id="displayPoints">0</span>
                    </div>
                    <div style="flex:1; border-left:1px solid #ccc;">
                        <span class="gps-label">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á (‡∏°.)</span>
                        <span class="gps-val" id="displayDistance">0</span>
                    </div>
                </div>
                <div style="margin-top:10px; font-size:12px; color:#555;">
                    ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: <span id="displayAccuracy" style="font-weight:bold;">-</span>
                </div>
            </div>
            
            <div id="controlPanel">
                <button class="calculate-btn" id="btnStartGPS" onclick="startSurvey()" style="background-color: #2e7d32; margin-top:15px;">
                    ‚ñ∂ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏£‡∏ß‡∏à
                </button>
                
                <button class="calculate-btn manual-pin-btn" id="btnDropPin" onclick="dropPin()" style="display:none;">
                    üìç ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏à‡∏∏‡∏î‡∏ô‡∏µ‡πâ (Pin)
                </button>

                <div id="savePanel" style="display:none; margin-top:20px; border-top:1px dashed #ccc; padding-top:10px;">
                    <div class="input-group">
                        <label>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:</label>
                        <input type="text" id="trackName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≤‡∏¢‡∏õ‡πâ‡∏≠‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏î‡∏≠‡∏ô">
                    </div>
                    <div class="input-group">
                        <label>‡∏ú‡∏π‡πâ‡∏™‡∏≥‡∏£‡∏ß‡∏à:</label>
                        <input list="surveyorList" id="surveyorName" placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà...">
                        <datalist id="surveyorList"></datalist>
                    </div>
                    <button class="calculate-btn" onclick="saveTrack()" style="background-color: #1976d2;">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤ Drive
                    </button>
                    <button class="calculate-btn" onclick="resetSurvey()" style="background-color: #d32f2f; margin-top:10px;">
                        ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å / ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                    </button>
                </div>
            </div>

            <div class="history-list" id="savedListContainer" style="display:none;">
                <h3 style="margin-top:0; color:#555; font-size:16px;">üìÇ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h3>
                <div id="savedRoutesList"></div>
                <div class="note" style="text-align:center; color:#d32f2f; cursor:pointer;" onclick="initDelete('all', null)">
                    [‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î]
                </div>
            </div>

            <div class="note">
                * ‡∏†‡∏≤‡∏û‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå KML ‡πÉ‡∏ô Google Drive
            </div>
        </div>
    </div>

    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <h3>üîí ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
            <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            <input type="password" id="adminPassword" placeholder="PIN" inputmode="numeric">
            <div style="display:flex; gap:10px;">
                <button class="calculate-btn" style="background:#ccc; color:#333;" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="calculate-btn" id="btnConfirmDelete">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <div id="imageModal" class="modal" onclick="closeImageModal()">
        <div class="modal-content" style="max-width: 90%; background:transparent; box-shadow:none;">
            <img id="fullImage" style="width:100%; border-radius:8px; border:2px solid white;">
            <button class="calculate-btn" onclick="closeImageModal()" style="margin-top:10px; background:white; color:black;">‡∏õ‡∏¥‡∏î</button>
        </div>
    </div>

    <footer>Developed by ‡∏ä‡∏ú.‡∏ö‡∏™.‡∏Å‡∏ü‡∏à.‡∏ô‡∏û.</footer>

    <script>
        // *** ‡πÉ‡∏™‡πà URL Script ‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ***
        var SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw9LqjHRaZcJ8PXUQAwX5E9jo391wUDiQhEexn-JBk2VdSPoetYWKihID8t2tg1uaJV/exec"; 

        // --- Image Handling ---
        var currentImageData = null; // ‡πÄ‡∏Å‡πá‡∏ö Base64 ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ

        function handleImageSelect(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    // ‡πÅ‡∏™‡∏î‡∏á Preview
                    var img = document.getElementById('previewImg');
                    img.src = e.target.result;
                    img.style.display = 'block';
                    
                    // ‡∏¢‡πà‡∏≠‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö (Compress)
                    compressImage(e.target.result, 800, 0.7, function(compressedData) {
                        currentImageData = compressedData;
                        document.getElementById('imgStatus').style.display = 'block';
                        document.getElementById('imgStatus').innerText = "‚úÖ ‡∏£‡∏π‡∏õ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (‡∏¢‡πà‡∏≠‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏•‡πâ‡∏ß)";
                    });
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function compressImage(base64Str, maxWidth, quality, callback) {
            var img = new Image();
            img.src = base64Str;
            img.onload = function () {
                var canvas = document.createElement('canvas');
                var width = img.width;
                var height = img.height;

                if (width > maxWidth) {
                    height = Math.round(height * (maxWidth / width));
                    width = maxWidth;
                }

                canvas.width = width;
                canvas.height = height;
                var ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, width, height);
                
                // ‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Base64 ‡πÅ‡∏ö‡∏ö JPEG
                var compressedData = canvas.toDataURL("image/jpeg", quality);
                callback(compressedData);
            }
        }

        function showImage(id) {
            var savedTracks = JSON.parse(localStorage.getItem('pea_gps_tracks') || "[]");
            var track = savedTracks.find(t => t.id === id);
            if(track && track.image) {
                document.getElementById('fullImage').src = track.image;
                document.getElementById('imageModal').style.display = 'flex';
            } else {
                alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ");
            }
        }
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }

        // --- Tab Logic ---
        function openTab(tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) { tabcontent[i].className = tabcontent[i].className.replace(" active", ""); }
            tablinks = document.getElementsByTagName("button");
            for (i = 0; i < tablinks.length; i++) { tablinks[i].classList.remove("active"); }
            document.getElementById(tabName).className += " active";
            if(document.getElementById("btn-" + tabName)) document.getElementById("btn-" + tabName).classList.add("active");
            
            if(tabName === 'gpsSurvey') {
                loadSavedTracks();
                fetchSurveyors();
            }
        }
        
        // --- GPS Logic ---
        var watchID = null;
        var currentLat = null, currentLon = null, currentAcc = null;
        var recordedPoints = [];
        var totalDistance = 0;

        function startSurvey() {
            if (!navigator.geolocation) { alert("‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö GPS"); return; }
            
            recordedPoints = [];
            totalDistance = 0;
            updateUI(0, 0);

            document.getElementById('btnStartGPS').style.display = 'none';
            document.getElementById('btnDropPin').style.display = 'block';
            document.getElementById('savePanel').style.display = 'block';
            document.getElementById('gpsStatusText').innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì...";

            watchID = navigator.geolocation.watchPosition(
                function(pos) {
                    currentLat = pos.coords.latitude;
                    currentLon = pos.coords.longitude;
                    currentAcc = pos.coords.accuracy;
                    document.getElementById('displayAccuracy').innerText = "¬±" + Math.round(currentAcc) + " ‡∏°.";
                    
                    var gpsBox = document.getElementById('gpsBox');
                    var statusText = document.getElementById('gpsStatusText');

                    if(currentAcc > 20) {
                        gpsBox.className = "gps-status waiting";
                        statusText.innerText = "‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡πà‡∏≠‡∏ô (‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...)";
                        statusText.style.color = "#e65100";
                    } else {
                        gpsBox.className = "gps-status";
                        statusText.innerText = "GPS ‡∏û‡∏£‡πâ‡∏≠‡∏°! ‡∏Å‡∏î‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ñ‡∏∂‡∏á‡∏à‡∏∏‡∏î";
                        statusText.style.color = "#2e7d32";
                    }
                },
                function(err) { console.warn(err); },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        function dropPin() {
            if (currentLat === null) { alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì GPS"); return; }
            var newPoint = [currentLon, currentLat];
            if (recordedPoints.length > 0) {
                var lastPt = recordedPoints[recordedPoints.length - 1];
                var dist = calcDist(lastPt[1], lastPt[0], currentLat, currentLon);
                totalDistance += dist;
            }
            recordedPoints.push(newPoint);
            updateUI(recordedPoints.length, totalDistance);
            
            var btn = document.getElementById('btnDropPin');
            var originalText = btn.innerText;
            btn.innerText = "‚úÖ ‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß!";
            btn.style.backgroundColor = "#43a047";
            setTimeout(() => { btn.innerText = originalText; btn.style.backgroundColor = "#f57f17"; }, 1000);
        }

        function updateUI(points, dist) {
            document.getElementById('displayPoints').innerText = points;
            document.getElementById('displayDistance').innerText = dist.toFixed(0);
        }

        function resetSurvey() {
            if(!confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ?")) return;
            if(watchID) navigator.geolocation.clearWatch(watchID);
            watchID = null;
            document.getElementById('btnStartGPS').style.display = 'block';
            document.getElementById('btnDropPin').style.display = 'none';
            document.getElementById('savePanel').style.display = 'none';
            document.getElementById('gpsStatusText').innerText = "‡∏Å‡∏î '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏£‡∏ß‡∏à' ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î GPS";
            document.getElementById('displayAccuracy').innerText = "-";
            
            // Reset Image
            currentImageData = null;
            document.getElementById('previewImg').style.display = 'none';
            document.getElementById('cameraInput').value = "";
            document.getElementById('imgStatus').style.display = 'none';
        }

        function calcDist(lat1, lon1, lat2, lon2) {
            var R = 6371e3; var œÜ1 = lat1 * Math.PI/180; var œÜ2 = lat2 * Math.PI/180;
            var ŒîœÜ = (lat2-lat1) * Math.PI/180; var ŒîŒª = (lon2-lon1) * Math.PI/180;
            var a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) + Math.cos(œÜ1) * Math.cos(œÜ2) * Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c;
        }

        // --- Save & Upload ---
        function fetchSurveyors() {
            fetch(SCRIPT_URL, {
                method: 'POST', mode: 'cors',
                headers: {'Content-Type': 'text/plain;charset=utf-8'},
                body: JSON.stringify({ action: 'get_surveyors' })
            })
            .then(res => res.json())
            .then(data => {
                var list = document.getElementById('surveyorList');
                list.innerHTML = "";
                data.names.forEach(name => {
                    var opt = document.createElement('option'); opt.value = name; list.appendChild(opt);
                });
            });
        }

        function saveTrack() {
            if(recordedPoints.length < 2) { alert("‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏±‡∏Å‡∏´‡∏°‡∏∏‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏à‡∏∏‡∏î"); return; }
            
            var name = document.getElementById('trackName').value || "‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏™‡∏≥‡∏£‡∏ß‡∏à";
            var surveyor = document.getElementById('surveyorName').value || "";
            var now = new Date();
            var dateStr = now.toLocaleDateString('th-TH') + " " + now.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
            var safeDate = dateStr.replace(/[: \/]/g, '-');
            
            if(watchID) navigator.geolocation.clearWatch(watchID);
            watchID = null;

            var newTrack = { 
                id: Date.now(), 
                name: name, 
                surveyor: surveyor, 
                date: dateStr, 
                dist: totalDistance, 
                points: recordedPoints, 
                uploaded: false,
                image: currentImageData // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡∏á‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
            };
            
            var savedTracks = JSON.parse(localStorage.getItem('pea_gps_tracks') || "[]");
            savedTracks.push(newTrack);
            localStorage.setItem('pea_gps_tracks', JSON.stringify(savedTracks));
            
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô Cloud...");
            var kmlContent = genKML(newTrack);

            fetch(SCRIPT_URL, {
                method: 'POST', mode: 'cors',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify({
                    action: 'upload',
                    folderName: newTrack.name,
                    filename: newTrack.name + "_" + safeDate + ".kml",
                    content: kmlContent,
                    surveyor: surveyor,
                    image: currentImageData // ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏õ Server
                })
            })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    alert("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÄ‡∏Ç‡πâ‡∏≤ Drive ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
                    markAsUploaded(newTrack.id);
                } else alert("‚ö† ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + data.message);
            })
            .finally(() => {
                resetSurvey(); // Reset Form
                loadSavedTracks();
            });
        }

        function markAsUploaded(id) {
            var savedTracks = JSON.parse(localStorage.getItem('pea_gps_tracks') || "[]");
            var track = savedTracks.find(t => t.id === id);
            if(track) track.uploaded = true;
            localStorage.setItem('pea_gps_tracks', JSON.stringify(savedTracks));
            loadSavedTracks();
        }

        function loadSavedTracks() {
            var savedTracks = JSON.parse(localStorage.getItem('pea_gps_tracks') || "[]");
            var container = document.getElementById('savedRoutesList');
            var listContainer = document.getElementById('savedListContainer');
            container.innerHTML = "";
            if (savedTracks.length === 0) { listContainer.style.display = "none"; return; }
            listContainer.style.display = "block";
            
            for (var i = savedTracks.length - 1; i >= 0; i--) {
                var t = savedTracks[i];
                var uploadStatus = t.uploaded ? '<span style="color:#2e7d32;">‚úî Cloud</span>' : '<span style="color:#f57f17;">‚ö† Local</span>';
                var number = (savedTracks.length - i);
                var surveyorInfo = t.surveyor ? ` | üë§ ${t.surveyor}` : "";
                
                // ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏π‡∏£‡∏π‡∏õ (‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ)
                var photoBtn = t.image ? `<button onclick="showImage(${t.id})" style="background-color:#607d8b;">üì∑ ‡∏£‡∏π‡∏õ</button>` : '';

                var html = `
                <div class="history-item">
                    <div class="upload-status" style="display:block;">${uploadStatus}</div>
                    <div>
                        <div class="history-info">${number}. ${t.name} <span style="font-weight:normal; font-size:13px;">(${t.dist.toFixed(0)} ‡∏°.)</span></div>
                        <div class="history-meta">${t.date} | ${t.points.length} ‡∏à‡∏∏‡∏î${surveyorInfo}</div>
                    </div>
                    <div class="history-actions">
                        ${photoBtn}
                        <button onclick="exportSingleTrack(${t.id})" style="background-color:#ff9800;">‚¨á KML</button>
                        <button onclick="initDelete('single', ${t.id})" style="background-color:#d32f2f;">üóë ‡∏•‡∏ö</button>
                    </div>
                </div>`;
                container.innerHTML += html;
            }
        }

        // ... (Functions: genKML, exportSingleTrack, Secure Delete ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°) ...
        function genKML(track) {
            var desc = `Surveyor: ${track.surveyor || '-'}\nDistance: ${track.dist.toFixed(0)} m`;
            var k = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>${track.name}</name><description>${desc}</description><Style id="lineStyle"><LineStyle><color>ff0000ff</color><width>4</width></LineStyle></Style><Style id="pinStyle"><IconStyle><scale>1.1</scale><Icon><href>http://maps.google.com/mapfiles/kml/pushpin/red-pushpin.png</href></Icon></IconStyle></Style><Placemark><name>Path</name><styleUrl>#lineStyle</styleUrl><LineString><tessellate>1</tessellate><coordinates>`;
            for (var i = 0; i < track.points.length; i++) { k += track.points[i][0] + "," + track.points[i][1] + ",0 "; }
            k += `</coordinates></LineString></Placemark><Folder><name>Points</name>`;
            for (var j = 0; j < track.points.length; j++) { k += `<Placemark><name>P${j+1}</name><styleUrl>#pinStyle</styleUrl><Point><coordinates>${track.points[j][0]},${track.points[j][1]},0</coordinates></Point></Placemark>`; }
            k += `</Folder></Document></kml>`;
            return k;
        }
        function exportSingleTrack(id) {
            var savedTracks = JSON.parse(localStorage.getItem('pea_gps_tracks') || "[]");
            var track = savedTracks.find(t => t.id === id); if(!track) return;
            var kmlContent = genKML(track);
            var blob = new Blob([kmlContent], { type: 'application/vnd.google-earth.kml+xml' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a'); link.href = url; link.download = track.name + ".kml";
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }
        var deleteTargetId = null; var deleteMode = null;
        function initDelete(mode, id) { deleteMode = mode; deleteTargetId = id; document.getElementById('adminPassword').value = ""; document.getElementById('passwordModal').style.display = "flex"; document.getElementById('adminPassword').focus(); }
        function closeModal() { document.getElementById('passwordModal').style.display = "none"; }
        document.getElementById('btnConfirmDelete').onclick = function() {
            var pass = document.getElementById('adminPassword').value; var btn = document.getElementById('btnConfirmDelete'); if(!pass) return;
            btn.innerText = "‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö..."; btn.disabled = true;
            fetch(SCRIPT_URL, { method: 'POST', mode: 'cors', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify({ action: 'check_pass', password: pass }) })
            .then(res => res.json()).then(data => { if(data.valid) { performDelete(); closeModal(); } else alert("‚ùå ‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î"); })
            .finally(() => { btn.innerText = "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô"; btn.disabled = false; });
        };
        function performDelete() {
            if (deleteMode === 'all') localStorage.removeItem('pea_gps_tracks');
            else { var savedTracks = JSON.parse(localStorage.getItem('pea_gps_tracks') || "[]"); savedTracks = savedTracks.filter(t => t.id !== deleteTargetId); localStorage.setItem('pea_gps_tracks', JSON.stringify(savedTracks)); }
            loadSavedTracks();
        }
    </script>
</body>
</html>